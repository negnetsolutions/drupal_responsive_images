// Responsive Image Loader 1.1
// Negnet Solutions 2014
// GPL Licensed

(function ($, undefined) {

  var ticking = false;
  var timer;

  function isHighDensity(){
    return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 124dpx), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dppx)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) || (window.devicePixelRatio && window.devicePixelRatio > 1.3));
  }

  function loadResponsiveImage(image){

    //setup data_src for each image element
    var data_src;

    var width_requirements = $(image).parent().width();
    if(width_requirements <= 0) {
      width_requirements = $(window).width();
    }

    //detect if high density display. Multiply requirement by 1.5
    if(isHighDensity()){
      width_requirements = width_requirements*1.5;
    }

    $('div',image).each(function(i, val){
      var min = parseFloat($(this).data('min'));

      if(width_requirements >= min){
        // if our window width is more than min, overwrite data_src
        data_src = $(this).data('src');
      }
      else
      {
        //break the loop if we have hit our max
        //best fit is already found
        return false;
      }
    });

    if( $('img',image).attr('src') != data_src ){
      //change our image source to the best fit
      $('img',image).attr("src",data_src);
    }
  }
  function _loadResponsiveImages(){
    $('.responsive-image').each(function(){
      loadResponsiveImage(this);
    });
    ticking = false;
  }
  function loadResponsiveImages(){
    if(!ticking){
      try {
        window.requestAnimationFrame(_loadResponsiveImages);
      }
      catch(err){
        //fallback if requestanimationframe is unavailable
        timer && clearTimeout(timer);
        timer = setTimeout(_loadResponsiveImages, 100);
      }
      ticking = true;
    }
  }

  $(document).ready(function() {
    loadResponsiveImages();
    $('.responsive-image img').bind('load', function() {
      loadResponsiveImage( $(this).parent() );
    });
  });

  $(window).bind('resize', function(){
    loadResponsiveImages();
  });

}(jQuery));
